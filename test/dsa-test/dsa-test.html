<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>test DSA CALCULATION</title>

  <script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../bower_components/web-component-tester/browser.js"></script>

  <link rel="import" href="../../t2f/app-elements/api-elements/outbound-data.html">
  <link rel="import" href="../../t2f/app-elements/field-set-elements/travel-deductions.html">

  <link rel="import" href="./data/case-1.html">

</head>
<body>

<test-fixture id="el">
  <template>
    <et2f-outbound-data postData="true" id="api"></et2f-outbound-data>
    <travel-deductions id="deductions"></travel-deductions>
  </template>
</test-fixture>

<script>

  /* global define, suite, setup, fixture, test, caseScenarios, expect */
  suite('dsa-test', function() {

    var el = null;
    var dom = null;
    var deductions = null;
    var deductionsItems = null;
    var api = null;
    var data = caseScenarios;
    var deDom = null;

    setup(function() {

      el = fixture('el');
      dom = Polymer.dom(el.root);

      deductions = dom.querySelector('#deductions');
      deductionsItems = function() {
        return deductions.$.deductions_list.items;
      };

      api = dom.querySelector('#api');
      dom.flush();
    });

    test('base#1 - it parses injected deduction', function() {

      deductions.itinerary = data.simple.itinerary;
      deductions.deductions = [];
      data.simple.deductions = deductions.deductions;

      if (expect(data.simple.deductions.length).to.equal(1)) {
        console.log('âœ…');
      } else {
        console.log('ðŸ’”');
      }
    });

    test('base#2 - the API sends data to the server, and we\'re getting it back', function(done) {

      deductions.itinerary = data.simple.itinerary;
      deductions.deductions = [];
      data.simple.deductions = deductions.deductions;

      api.data = JSON.parse(JSON.stringify(data.simple));

      api._handlePostSuccess = function(e, data) {

        if (expect(data).to.be.an('object')) {
          console.log('âœ…');
        } else {
          console.log('ðŸ’”');
        }
        done();
      }

      api.doRequest({endPoint: 'save'});
    });

    test('dsa#1 - Simple usecase (two days, there and back should be 140%, so 420$)', function(done) {

      deductions.itinerary = data.simple.itinerary;
      deductions.deductions = [];
      data.simple.deductions = deductions.deductions;

      api.data = JSON.parse(JSON.stringify(data.simple));

      api._handlePostSuccess = function(e, data) {

        var gotBackDsa = data.cost_summary.dsa_total;
        if (expect(gotBackDsa).to.equal('420.00')) {console.log('âœ…')}
        done();
      };

      api.doRequest({endPoint: 'save'});
    });

    test('dsa#2 - Over 60 days, (92 day long simple trip (back and forth, no deduction) should be 18.000 + 6200 + 80 = 24.280$)', function(done) {

      deductions.itinerary = data.longerThan60.itinerary;
      deductions.deductions = [];
      data.longerThan60.deductions = deductions.deductions;

      api.data = JSON.parse(JSON.stringify(data.longerThan60));

      api._handlePostSuccess = function(e, data) {

        var gotBackDsa = data.cost_summary.dsa_total;
        if (expect(gotBackDsa).to.equal('24280.00')) {console.log('âœ…')}
        done();
      };

      api.doRequest({endPoint: 'save'});
    });

    test('dsa#2 - Same day travel, 8- hrs, (expected: 0$)', function(done) {

      deductions.itinerary = data.sameDay.itinerary;
      deductions.deductions = [];
      data.sameDay.deductions = deductions.deductions;

      api.data = JSON.parse(JSON.stringify(data.sameDay));

      api._handlePostSuccess = function(e, data) {

        var gotBackDsa = data.cost_summary.dsa_total;
        if (expect(gotBackDsa).to.equal('0.00')) {console.log('âœ…')}
        done();
      };

      api.doRequest({endPoint: 'save'});
    });

    test('dsa#3 - Same day travel (8+ hours trip, back and forth, no deduction: should be 40% * 300 = 120$)', function(done) {

      deductions.itinerary = data.sameDayLonger.itinerary;
      deductions.deductions = [];
      data.sameDayLonger.deductions = deductions.deductions;

      api.data = JSON.parse(JSON.stringify(data.sameDayLonger));

      api._handlePostSuccess = function(e, data) {

        var gotBackDsa = data.cost_summary.dsa_total;
        if (expect(gotBackDsa).to.equal('120.00')) {console.log('âœ…')}
        done();
      };

      api.doRequest({endPoint: 'save'});
    });

    test('deduction#1 - Overnight travel', function() {

      console.log('ðŸš§');
    });

    test('deduction#2 - No DSA as deduction checked on the first day of case#1, expected baseDSA: 420$, expected deductions: 300$', function(done) {

      deductions.itinerary = data.simple.itinerary;
      deductions.deductions = [];
      data.simple.deductions = deductions.deductions;

      // Set no DSA for first day
      deductionsItems()[0].no_dsa = true;

      api.data = JSON.parse(JSON.stringify(data.simple));

      api._handlePostSuccess = function(e, data) {

        var gotBackDsa = data.cost_summary.dsa_total;
        var gotDeductions = data.cost_summary.deductions_total;

        if (
          expect(gotBackDsa).to.equal('420.00') &&
          expect(gotDeductions).to.equal('300.00')
        ) {
          console.log('âœ…')
        }
        done();
      };

      api.doRequest({endPoint: 'save'});
    });

    test('deduction#3 - Dinner, lunch, breakfast, accomodation (-80% deduction of first day, only 40% DSA for second(last) day, expected DSA: (300+120=) 420$, expected deductions: 240$)', function(done) {

      deductions.itinerary = data.simple.itinerary;
      deductions.deductions = [];
      data.simple.deductions = deductions.deductions;

      // Set deductions
      deductionsItems()[0].accomodation = true;
      deductionsItems()[0].breakfast = true;
      deductionsItems()[0].dinner = true;
      deductionsItems()[0].lunch = true;

      api.data = JSON.parse(JSON.stringify(data.simple));

      api._handlePostSuccess = function(e, data) {

        var gotBackDsa = data.cost_summary.dsa_total;
        var gotDeductions = data.cost_summary.deductions_total;

        if (
          expect(gotBackDsa).to.equal('420.00') &&
          expect(gotDeductions).to.equal('240.00')
        ) {
          console.log('âœ…');
        }
        done();
      };

      api.doRequest({endPoint: 'save'});
    });

    test('deduction#4 - Multiple DSAs', function() {});
    test('deduction#5 - Currency issues?', function() {});

    test('complex#1 - Really complex calculation A', function() {});
    test('complex#2 - Really complex calculation B', function() {});
    test('complex#3 - Really complex calculation C', function() {});
  });
</script>

</body>
</html>
