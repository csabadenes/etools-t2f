<link rel="import" href="../scripts/lodash/lodash.html">

<script>

  var ListBehavior = {

    properties: {

      route: {
        type: Object,
        observer: '_routeObserver',
      },
    },

    // Computes the ajax parameters from the URL params & the default ones
    _computeAjaxParams: function(UrlParams) {
      function shallowEqual(O1, O2) {
        var keys1 = Object.keys(O1);
        var keys2 = Object.keys(O2);

        if (keys1.length !== keys2.length) {
          // console.log('Length problem!', keys1, keys2);
          return false;
        }

        keys = _.union(keys1, keys2);
        for (i = 0; i < keys.length; i++) {
          if (O1[keys[i]] == O2[keys[i]]) {
            continue;
          } else {
            // console.log('Diff @', keys[0], O1[keys[i]], O2[keys[i]]);
            return false;
          }
        }
        return true;
      }

      var defaultParams = {
        reverse: 'true',
        page: '1',
        page_size: '10',
        search: '',
      };

      defaultParams.sort_by = {
        'travel-list': 'reference_number',
        'action-points-list': 'action_point_number',
        'invoices-list': 'reference_number',
      }[this.is];

      if (this.is === 'travel-list') {
        defaultParams.show_hidden = 'false';
      }

      var ret = _.merge(defaultParams, UrlParams);

      if (!shallowEqual(ret, UrlParams)) {
        console.warn('this should only happen on list startup!!!');
        this.set('route.__queryParams', ret);
      }

      // console.info('SETTING AJAX PARAMS:', JSON.stringify(ret));
      return ret;
    },

    // If the old route could have change the content, refresh data
    _routeObserver: function(newValue, oldValue) {

      var componentName = this.is;
      if (!oldValue || !newValue || !oldValue.path || !newValue.path) {
        return;
      }
      if (newValue.path.indexOf(componentName) > -1 || !(oldValue.path.indexOf(componentName))) {
       this._doRefreshData();
      }
    },

    _computePagesObj: function(params) {
      return {
        itemsPerPage: params.page_size,
        page: params.page,
      };
    },

    _computeOrderObj: function(params) {
      return {
        orderedBy: params.sort_by,
        reverse: params.reverse,
      };
    },

    // Refresh data by triggering automatic API call
    _doRefreshData: function() {

      console.warn('TODO: refresh logic!');
      // this.notifyPath('route.__queryParams');

      // var backup = this.ajaxParams;
      // this.set('ajaxParams', {});
      // this.set('ajaxParams', backup);
    },

    // Changes the searchString prop only if it was "entered"
    searchKeyDown: function(e) {

      if (e.keyCode === 13) {     // Enter was hit

        var input = this.$['search-input'];

        this.set('searchString', input.value);
        input.focus();
      }
    },

    // Sets the query for search, auto-triggers API call
    _searchStringChanged: function(searchStr, old) {

      if (typeof old === 'undefined') {
        return;
      }
      var backup = JSON.parse(JSON.stringify(this.route.__queryParams));
      backup.search = searchStr;
      this.set('route.__queryParams', backup);
      // var backup = JSON.parse(JSON.stringify(this.ajaxParams));
      // backup.search = searchStr;
      // this.set('ajaxParams', backup);
    },

    // Stiches the string "0-10 of 35 trips" together
    _computeResultsToShow: function(pages, datalength) {
      var start = (pages.page - 1) * pages.itemsPerPage;
      var end = (pages.itemsPerPage * pages.page) > datalength ?
                 datalength : (pages.itemsPerPage * pages.page);
      return start + ' - ' + end + ' of ' + datalength;
    },

    // Adds a filter to the view
    addFilter: function(e) {

      var newFilter = this.filters.filter(function(filter) {
        return filter.name === e.model.item.name;
      })[0];

      this.set('availableFilters', this.availableFilters.filter(function(filter) {
        return filter.name !== newFilter.name;
      }));

      this.push('usedFilters', newFilter);
    },

    // Removes filter from the view
    removeFilter: function(e) {

      var filterName = e.model.item.name;
      var pristineFilter = this.filters.filter(function(filter) {
        return filter.name === filterName;
      })[0];

      var backup = JSON.parse(JSON.stringify(this.route.__queryParams));
      delete backup[e.model.item.filterName];
      this.set('route.__queryParams', backup);

      this.push('availableFilters', pristineFilter);

      var indexToRemove = this.usedFilters.indexOf(e.model.item);

      this.splice('usedFilters', indexToRemove, 1);
    },

    fillAvailableFilters: function(filters) {
      this.set('availableFilters', filters);
    },

    // Sets the filter/search/toggle parameters if got from URL
    attached: function() {

      var self = this;
      var params = this.route.__queryParams;

      if (this.is === 'travel-list') {
        var toggled = params.show_hidden === 'true';
        this.$['show-hidden-toggle'].checked = toggled;
      }

      var searchStr = params.search || '';
      this.$['search-input'].value = searchStr;

      var filters = this._computeFilters(this.structure);

      // Init filters
      filters.forEach(function(filt) {
        var isPresent = params.hasOwnProperty(filt.filterName);
        if (isPresent) {
          var clickMockObj = {
            model: {
              item: filt,
            },
          };
          self.addFilter(clickMockObj);
        }
      });

      // Prefill filters
      filters.forEach(function(filt) {
        var isPresent = params.hasOwnProperty(filt.filterName);
        if (isPresent) {
          var selected = filt.selection.filter(function(sel) {
            return sel.value == params[filt.filterName];
          })[0];

          self.async(function() {
            var ssm = Polymer.dom(this.root).querySelector('#' + filt.filterName);
            ssm.value = selected;
          });
        }
      });
    },

  };
</script>
