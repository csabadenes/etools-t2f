<link rel="import" href="../scripts/lodash/lodash.html">

<script>

  var ListBehavior = {

    properties: {
      route: Object,
    },

    // Computes the ajax parameters from the URL params & the default ones
    _computeAjaxParams: function(route) {
      function shallowEqual(O1, O2) {
        var keys1 = Object.keys(O1);
        var keys2 = Object.keys(O2);

        if (keys1.length !== keys2.length) {
          return false;
        }

        var keys = _.union(keys1, keys2);
        for (var i = 0; i < keys.length; i++) {
          /* jshint eqeqeq: false */
          if (O1[keys[i]] == O2[keys[i]]) {
            continue;
          } else {
            return false;
          }
        }
        return true;
      }

      // If the params are for another list, can run a lot!
      if (route.path.indexOf(this.is) < 0) {

        return this.ajaxParams;

      } else {

        var defaultParams = {
          reverse: 'true',
          page: '1',
          page_size: '10',
          search: '',
        };
        defaultParams.sort_by = {
          'travel-list': 'reference_number',
          'action-points-list': 'action_point_number',
          'invoices-list': 'id',
        }[this.is];
        if (this.is === 'travel-list') {
          defaultParams.show_hidden = 'false';
        }

        var ret = _.merge(defaultParams, route.__queryParams);

        if (!shallowEqual(ret, route.__queryParams)) {
          this.set('route.__queryParams', ret);
        }

        return ret;
      }
    },

    _computePagesObj: function(params) {
      return {
        itemsPerPage: params.page_size,
        page: params.page,
      };
    },

    _computeOrderObj: function(params) {
      return {
        orderedBy: params.sort_by,
        reverse: params.reverse,
      };
    },

    // Changes the searchString prop only if it was "entered"
    searchKeyDown: function(e) {

      if (e.keyCode === 13) {     // Enter was hit

        var input = this.$['search-input'];

        this.set('searchString', input.value);
        input.focus();
      }
    },

    // Sets the query for search, auto-triggers API call
    _searchStringChanged: function(searchStr, old) {

      if (typeof old === 'undefined') {
        return;
      }
      var backup = JSON.parse(JSON.stringify(this.route.__queryParams));
      backup.search = searchStr;
      this.set('route.__queryParams', backup);
    },

    // Stiches the string "0-10 of 35 trips" together
    _computeResultsToShow: function(pages, datalength) {
      var start = (pages.page - 1) * pages.itemsPerPage;
      var end = (pages.itemsPerPage * pages.page) > datalength ?
                 datalength : (pages.itemsPerPage * pages.page);
      return start + ' - ' + end + ' of ' + datalength;
    },

    // Adds a filter to the view
    addFilter: function(e) {

      var newFilter = this.filters.filter(function(filter) {
        return filter.name === e.model.item.name;
      })[0];

      this.set('availableFilters', this.availableFilters.filter(function(filter) {
        return filter.name !== newFilter.name;
      }));

      this.push('usedFilters', newFilter);
    },

    // Removes filter from the view
    removeFilter: function(e) {

      var filterName = e.model.item.name;
      var pristineFilter = this.filters.filter(function(filter) {
        return filter.name === filterName;
      })[0];

      var backup = JSON.parse(JSON.stringify(this.route.__queryParams));
      delete backup[e.model.item.filterName];
      this.set('route.__queryParams', backup);

      this.push('availableFilters', pristineFilter);

      var indexToRemove = this.usedFilters.indexOf(e.model.item);

      this.splice('usedFilters', indexToRemove, 1);
    },

    fillAvailableFilters: function(filters) {
      this.set('availableFilters', filters);
    },

    // Sets the filter/search/toggle parameters if got from URL
    commonAttached: function() {

      var self = this;
      var params = this.route.__queryParams;

      var searchStr = params.search || '';
      this.$['search-input'].value = searchStr;

      var filters = this._computeFilters(this.structure);

      // Init filters
      filters.forEach(function(filt) {
        var isPresent = params.hasOwnProperty(filt.filterName);
        if (isPresent) {
          var clickMockObj = {
            model: {
              item: filt,
            },
          };
          self.addFilter(clickMockObj);
        }
      });

      // Prefill filters
      filters.forEach(function(filt) {
        var isPresent = params.hasOwnProperty(filt.filterName);
        if (isPresent) {
          var selected = filt.selection.filter(function(sel) {
            /* jshint eqeqeq: false */
            return sel.value == params[filt.filterName];
          })[0];

          self.async(function() {
            var ssm = Polymer.dom(this.root).querySelector('#' + filt.filterName);
            ssm.value = selected;
          });
        }
      });
    },

  };
</script>
