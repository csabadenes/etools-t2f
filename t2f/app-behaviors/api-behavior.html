<script>


  var ApiBehavior = {
    properties: {
    },
    _convertDate: function(item) {
      if (!item) {
        return;
      }
      var date = new Date(item);
      return date;
    },
    _truncateNumber: function(item) {
      if (!item) {
        return;
      }
      return '' + parseFloat(item).toFixed(2);
    },
    _searchByLabel: function(structureData, value) {
      if (value) {
        return this.structure[structureData].find(function(item) {
          return item && item.label && (item.label.toLowerCase() === value.toLowerCase());
        });
      }
      return;
    },
    _multiFieldConversion: function(subField, fieldName, fieldSet) {
      var self = this;
      if (fieldSet instanceof Array) {
        return fieldSet.map(function(field) {
          return self.structure[fieldName].find(function(item) {
            return item[subField] === field;
          });
        });
      }
    },
    _convertOrKeepId: function(key, structureKey, value, cost_ass_instance) {
      if (cost_ass_instance && cost_ass_instance.delegate) {
        var ret = {
          label: null,
          value: value,
          toProcess: true,
        };
        return ret;
      } else {
        return this.structure[structureKey].find(function(item) {
          return item.value === value;
        });
      }
    },
    parseCostStructure: function(data) {

      data.funds = data.funds.map(function(fund) {
        return {
          label: fund.name,
          value: parseInt(fund.id, 10),
        };
      });

      data.grants = data.grants.map(function(grant) {
        return {
          label: grant.name,
          value: parseInt(grant.id, 10),
          funds: grant.funds.map(function(fundId) {
            return data.funds.find(function(rawFund) {
              return rawFund.value === fundId;
            });
          }),
        };
      });

      data.wbs = data.wbs.map(function(wbs) {
        return {
          business_area: wbs.business_area,
          label: wbs.name,
          value: parseInt(wbs.id, 10),
          grants: wbs.grants.map(function(grantId) {
            return data.grants.find(function(rawGrant) {
              return rawGrant.value === grantId;
            });
          }),
        };
      });

      data.parsed = true;
      return data;
    },
    _processLib: function(structureData, value, data) {
      if (typeof structureData  === 'function') {
        return structureData(value, data);
      }
      return this.structure[structureData].find(function(item) {
        return item.value === value;
      });
    },
    _log: function(structureData, value) {
      console.log(structureData, value);
      var result = this._processLib(structureData, value);
      console.log(result);
      return result;
    },
    _structureLib: function() {
      return {
        type: Object,
        value: {
          baseDetails: {
            traveler: 'users',
            supervisor: 'users',
            office: 'offices',
            section: 'sections',
            start_date: this._convertDate,
            end_date: this._convertDate,
            mode_of_travel: this._multiFieldConversion.bind(this, 'label', 'travel_modes'),
            currency: 'currencies'
          },
          activities: {
            locations: this._multiFieldConversion.bind(this, 'value', 'locations'),
            travel_type: this._searchByLabel.bind(this, 'travel_types'),
            partner: 'partners',
            partnership: 'partnerships',
            government_partnership: 'government_partnerships',
            result: 'results',
            date: this._convertDate,
            primary_traveler: 'users'
          },
          itinerary: {
            airlines: this._multiFieldConversion.bind(this, 'value', 'airlines'),
            mode_of_travel: this._searchByLabel.bind(this, 'travel_modes'),
            dsa_region: 'dsa_regions',
            departure_date: this._convertDate,
            arrival_date: this._convertDate,
          },
          expenses: {
            type: 'expense_types',
            document_currency: 'currencies',
            account_currency: 'currencies'
          },
          clearances: {},
          deductions: {},
          cost_assignments: {
            business_area: 'business_areas',
            wbs: this._convertOrKeepId.bind(this, 'wbs', 'wbs'),
            grant: this._convertOrKeepId.bind(this, 'grant', 'grants'),
            fund: this._convertOrKeepId.bind(this, 'fund', 'funds')
          },
          attachments: {
            type: this._searchByLabel.bind(this, 'attachment_types')
          },
          rejection_note: 'rejection_note',
          cert_rejection_note: 'cert_rejection_note',
          cancellation_note: 'cancellation_note',
          certification_note: 'certification_note',
          misc_expenses: 'misc_expenses',
          canceled_at: 'canceled_at',
          completed_at: 'completed_at',
          cost_summary: {},
          action_points: {
            due_date: this._convertDate,
            completed_at: this._convertDate,
            person_responsible: 'users',
            assigned_by: 'users',
            status: this._searchByLabel.bind(this, 'action_point_statuses')
          },
          invoice: {
            currency: 'currencies',
            items: {
              wbs: 'wbs',
              grant: 'grants',
              fund: 'funds'
            }
          }
        }
      };
    }
  };
  window.et2fBehaviors = window.et2fBehaviors ? window.et2fBehaviors : {};
  window.et2fBehaviors.ApiBehavior = ApiBehavior;
</script>
