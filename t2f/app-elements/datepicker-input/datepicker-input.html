<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/etools-datepicker/etools-datepicker-button.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/moment-element/moment-import.html">
<link rel="import" href="../../../bower_components/paper-time-picker/paper-time-picker.html">
<link rel="import" href="../../../bower_components/paper-time-picker/paper-time-picker-dialog-style.html">
<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">

<dom-module id="datepicker-input">
  <template>
    <style include="paper-time-picker-dialog-style">
      :host {
        display: block;
        width:100%;
      }
      *[hidden] {
        display: none;
      }
      paper-input {
        --paper-input-container-disabled: {
          opacity: 1;
        };
        --paper-input-container-label: {
          color: var(--gray-light);
        };
        --paper-input-container-underline: {
          border-color: var(--gray-light);
        };
        --paper-input-container-color: var(--gray-light);
        width: calc( 100% - 24px );
        margin-right:12px;
        margin-left: 12px;
      }
      paper-time-picker {
        --default-primary-color: var(--et2f-primary);
      }
      etools-datepicker-button {
        --etools-datepicker-btn: {
          color: var(--gray-mid);
        };
      }
    </style>

    <paper-input id="date-input"
      readonly
      label="[[label]]"
      always-float-label
      on-tap="_openCalendar"
      value="{{prettyDate}}"
      disabled$="[[disabled]]"
      error-message="[[errorMessage]]"
      required$="[[required]]"
      placeholder="[[placeholder]]"
      auto-validate$="[[autoValidate]]"
      invalid$="[[invalid]]">

      <etools-datepicker-button no-init open="{{opened}}" format="[[format]]" suffix json-date="{{date}}" date="[[date]]"></etools-datepicker-button>
    </paper-input>

    <paper-dialog id="timePickerDialog" modal class="paper-time-picker-dialog" on-iron-overlay-closed="_timeChanged">

      <paper-time-picker time="{{time}}" hour="{{hour}}" minute="{{minute}}"></paper-time-picker>

      <div class="buttons">

        <paper-button dialog-confirm>OK</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
    Polymer({
      is: 'datepicker-input',
      properties: {
        errorMessage: String,
        required: Boolean,
        placeholder: String,
        autoValidate: Boolean,
        timePicker: {
          type: Boolean,
          value: false
        },
        format: {
          type: String,
          computed: '_computeFormat(timePicker)'
        },
        invalid: Boolean,
        label: {
          type: String
        },
        date: {
          notify: true,
          observer: '_dateObserver'
        },
        time: {
          type: String,
        },
        prettyDate: {
          type: String,
        },
        opened: {
          type: Boolean,
          value: false,
          observer: '_openTimeSelector'
        },
        disabled: {
          type: Boolean,
          value: false
        }
      },
      observers: ['_dateChanged(date, format)'],
      _openTimeSelector: function(newValue, old) {
        if (old === true && newValue === false && this.timePicker) {
          this.$.timePickerDialog.open();
        }
      },
      _dateObserver: function(date) {
        if (date) {
          var time =  moment(date).format('hh:mm');
          this.set('time', time);
        } else {
          this.set('date', undefined);
          this.set('prettyDate', undefined);
        }
      },
      _timeChanged: function() {
        var mom = moment(this.date);
        var min = parseInt(this.minute, 10);
        var hour = parseInt(this.hour, 10);
        mom.hour(hour);
        mom.minute(min);
        this.set('date', mom.toDate());
      },
      _computeFormat: function(timePicker) {
        return timePicker ? 'LLL' : 'LL';
      },
      _dateChanged: function(date, format) {
        var prettyDate = date;
        if (date) {
          /* global moment */
          prettyDate =  moment(date).format(format);
        }
       this.set('prettyDate', prettyDate);
      },
      _openCalendar: function() {
        if (this.disabled) {
          return;
        } else if (!this.opened) {
          this.set('opened', true);
        }
      }

    });
  </script>
</dom-module>
