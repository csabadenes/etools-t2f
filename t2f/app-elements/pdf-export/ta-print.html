<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../app-config/etools-app-config.html">
<link rel="import" href="./pdf-images.html">
<link rel="import" href="../pdf-make-wrapper/pdf-make.html">
<link rel="import" href="../../../bower_components/moment-element/moment-with-locales-import.html">


<dom-module id="ta-print">

  <template>
    <pdf-make id="pdfMake" output="open" images="{{images}}" content="[[dataToPrint]]" styles="[[printStyles]]" page-orientation="portrait"></pdf-make>
    <pdf-images unicef-logo="{{unicefLogo}}" black-line="{{blackLine}}"> </pdf-images>
  </template>

  <script>

    Polymer({

      is: 'ta-print',

      properties: {
        data: {
          type: Object,
        },
        dataToPrint: {
          type: Object,
          computed: '_computeDataToPrint(data)',
        },
        printStyles: {
          type: Object,
          computed: '_computeStyles(data)',
        },
        unicefLogo: String,
        blackLine: String,
        images: {
          type: Object,
          computed: '_computeImages(unicefLogo, blackLine)'
        }
      },
      _computeStyles: function() {
        return {
          mainHeader: {
            fontSize: 16,
            bold: true,
            color: '#FFFFFF',
            fillColor: '#000000'
          },
          checkbox: {
            bold: true,
            color: '#FFFFFF',
            fillColor: '#000000'
          },
          checkboxRight: {
            bold: true,
            color: '#FFFFFF',
            fillColor: '#000000',
            alignment: 'right'
          },
          bold: {
            bold: true
          },
          rightAlign: {
            alignment: 'right'
          },
          leftAlign: {
            alignment: 'left'
          }
        };
      },
      _computeImages: function(unicefLogo, blackLine) {
        return {
          unicefLogo: unicefLogo,
          blackLine: blackLine
        };
      },
      _computeDataToPrint: function(incomingData) {
        if (!incomingData.baseDetails) {
          return;
        }
        var data = JSON.parse(JSON.stringify(incomingData));
        console.log(data);
        var dataToPrint = [];

        function printManyToMany(value) {
          if (value instanceof Array) {
            return value.reduce(function(prev, cur, index) {
              var tail = index === value.length - 1 ? '' : ',';
              return prev + cur.label + tail;
            }, '');
          }
          return '';
        }

        function print(item) {
          if (item) {
            if (item.label) {
              return item.label;
            }
            if (typeof(item) === 'string') {
              return item;
            }
            if (typeof(item) === 'number') {
              return '' + item;
            }
          }
          return '';
        }

        function printDate(date) {
          return window.moment(date).format('ll');
        }

        var logo = {
          image: 'unicefLogo',
          fit: [212,50],
          margin: [151,10]
        };
        var blackLine = {
          image: 'blackLine',
          fit: [515, 1],
          margin: [0, 20]
        };

        var firstLine = {
          columns: [
            {
              columns: [
                {text: 'Date: ', style: 'bold', width: 'auto', margin: [5,0]},
                {text: printDate(data.baseDetails.start_date)}
              ]
            },
            {text: 'travel authorization'.toUpperCase(), style: 'bold'},
            {
            columns: [
                {text: 'Tripo No. ', style: 'bold', width: 'auto'},
                {text: data.baseDetails.reference_number}
              ]
            }
          ]
        };

        var travelerData = {
          columns: [
            {stack: [
                {text: 'Name', style: 'bold'},
                {text: print(data.baseDetails.traveler)}
              ]
            },
            {stack: [
                {text: 'Index', style: 'bold'},
                {text: print(data.baseDetails.id)}
              ]
            }
          ]
        };

        var itineraryBLock = {
          columns: [
              {text: 'Purpose of travel', style: 'bold'},
              {text: print(data.baseDetails.purpose)},
          ],
          stack: data.itinerary.map(function(it) {
            return {
              columns: [
                {stack: [
                  {text: 'Departure date: ', style: 'bold'},
                  {text: 'Return date: ', style: 'bold'},
                  {text: 'From: ', style: 'bold'},
                ]}
              ]
            };
          })
        };

        dataToPrint.push(logo);
        dataToPrint.push(firstLine);
        dataToPrint.push(blackLine);
        dataToPrint.push(travelerData);
        return dataToPrint;
      },

      printTa: function() {
       this.$.pdfMake.printPDF();
      }

    });
  </script>
</dom-module>
