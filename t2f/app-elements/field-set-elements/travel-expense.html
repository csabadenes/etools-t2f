<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/etools-repeatable-field-set/etools-repeatable-field-set.html">
<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">

<link rel="import" href="../travel-status-box/travel-status.html">

<link rel="import" href="../../scripts/lodash/lodash.html">

<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../../styles/et2f-styles.html">

<dom-module id="travel-expense">
  <template>
    <style include="shared-styles et2f-styles iron-flex iron-flex-alignment iron-flex-factors">
      :host {
        display: block;
        width: 100%;
      }

      .custom-margin {
        --paper-input-container: {
          height: auto;
          margin-left: 12px;
          margin-right: 12px;
          margin-bottom: 12px;
        };
        --paper-checkbox-margin: 12px;
      }
    </style>

    <form is="iron-form" id="expense_form" class="layout vertical flex">

      <div class="layout horizontal">

        <etools-searchable-multiselection-menu label="Expense Type"
          id="type"
          class$="flex-3 [[computedPermission.type.readOnly]]"
          disabled="[[computedPermission.type.disabled]]"
          hidden$="[[computedPermission.type.hidden]]"
          empty-value
          options="[[expenseTypes]]"
          value="{{expense.type}}"
          placeholder="select"
          required$="[[computedPermission.type.required]]"
          on-paper-dropdown-close="_validateType"
          auto-validate$="[[autoValidate]]"
          starred>
        </etools-searchable-multiselection-menu>

        <paper-input label="Amount"
          class$="flex-3 custom-margin [[computedPermission.amount.readOnly]]"
          disabled="[[computedPermission.amount.disabled]]"
          hidden$="[[computedPermission.amount.hidden]]"
          pattern="^[0-9]+(\.[0-9]{1,2})?$"
          placeholder="eg.: 567.12"
          value="{{expense.amount}}"
          error-message="*number required"
          required$="[[computedPermission.amount.required]]"
          auto-validate
          starred>
        </paper-input>

        <etools-searchable-multiselection-menu label="Currency"
          id="curr1"
          class$="flex-3 [[computedPermission.document_currency.readOnly]]"
          disabled="[[computedPermission.document_currency.disabled]]"
          hidden$="[[computedPermission.document_currency.hidden]]"
          empty-value
          options="[[structure.currencies]]"
          value="{{expense.document_currency}}"
          placeholder="select"
          required$="[[computedPermission.document_currency.required]]"
          on-paper-dropdown-close="_validateDocCurr"
          auto-validate$="[[autoValidate]]"
          starred>
        </etools-searchable-multiselection-menu>

        <etools-searchable-multiselection-menu label="Accounting currency"
          id="curr2"
          class$="flex-3 [[computedPermission.account_currency.readOnly]]"
          disabled="[[computedPermission.account_currency.disabled]]"
          hidden$="[[computedPermission.account_currency.hidden]]"
          empty-value
          options="[[structure.currencies]]"
          value="{{expense.account_currency}}"
          placeholder="select"
          required$="[[computedPermission.account_currency.required]]"
          on-paper-dropdown-close="_validateAccCurr"
          auto-validate$="[[autoValidate]]"
          starred>
        </etools-searchable-multiselection-menu>
      </div>
    </form>
  </template>

  <script>
    Polymer({

      is: 'travel-expense',

      properties: {

        expense: {
          type: Object,
          notify: true,
        },

        autoValidate: {
          type: Boolean,
          computed: '_computeAutoValidate(expense)'
        },

        structure: {
          type: Object,
          value: {}
        },
        selectedExpenses: {
          type: Array,
        },
        expenseTypes: {
          type: Array,
          computed: '_computeExpenseTypes(structure.expense_types, selectedExpenses)',
        }
      },

      _computeAutoValidate: function(data) {
          return data !== undefined && Object.keys(data).length > 0;
      },

      behaviors: [et2fBehaviors.PermissionLayer],

      observers: [
        '_addValidationFunction(expense.*)'
      ],

      _computeExpenseTypes: function(structure, selectedExpenses) {
        var self = this;
        selectedExpenses = selectedExpenses.filter(function(selected) {
          return selected && selected.unique && self.expense.type ? selected.value !== self.expense.type.value : true;
        });
        var result = _.difference(structure, selectedExpenses);

        return result;
      },

      _addValidationFunction: function(changed) {

        if (!changed.base._validationFunction) {
          this.set('expense._validationFunction', this.validateExpense.bind(this, changed.base));
        }
      },

      _validateType: function(self) {
        if (!this.computedPermission.type.required) {
          return true;
        }

        if (this.expense.type || self.expense.type) {

          this.$.type.removeAttribute('invalid');
          return true;

        } else {

          this.$.type.setAttribute('invalid', true);
          return false;
        }
      },

      _validateDocCurr: function(self) {

        if (!this.computedPermission.document_currency.required) {
          return true;
        }

        if (this.expense.document_currency || self.expense.document_currency) {

          this.$.curr1.removeAttribute('invalid');
          return true;

        } else {

          this.$.curr1.setAttribute('invalid', true);
          return false;
        }
      },

      _validateAccCurr: function(self) {

        if (!this.computedPermission.account_currency.required) {
          return true;
        }

        if (this.expense.account_currency || self.expense.account_currency) {

          this.$.curr2.removeAttribute('invalid');
          return true;

        } else {

          this.$.curr2.setAttribute('invalid', true);
          return false;
        }
      },

      allEmpty: function() {
        var allEmpty = !this.expense.type &&
          !this.expense.amount &&
          !this.expense.document_currency &&
          !this.expense.account_currency;

        return allEmpty;
      },

      validateExpense: function() {

        if (this.allEmpty) {
          return true;
        }

        var typeValid = this._validateType(this);
        var accCurr = this._validateAccCurr(this);
        var docCurr = this._validateDocCurr(this);
        var formValid = this.$.expense_form.validate();

        return typeValid && formValid && accCurr && docCurr;
      }
    });
  </script>
</dom-module>
