<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../app-config/etools-app-config.html">


<dom-module id="et2f-structure-data">
  <template>
    <etools-ajax endpoint="[[staticDataEndpoint]]"
      on-success="_handleStaticData"
      loading="{{staticDataLoading}}"
      on-unauthorized="_redirectToLogin"
      on-forbidden="_redirectToLogin"
      caching-storage="dexie"
      ></etools-ajax>
    <etools-ajax endpoint="[[sectionsEndpoint]]"
      on-success="_handleSections"
      loading="{{sectionsLoading}}"
      on-unauthorized="_redirectToLogin"
      on-forbidden="_redirectToLogin"
      caching-storage="dexie"
      ></etools-ajax>
    <etools-ajax endpoint="[[officesEndpoint]]"
      on-success="_handleOffices"
      loading="{{officesLoading}}"
      on-unauthorized="_redirectToLogin"
      on-forbidden="_redirectToLogin"
      caching-storage="dexie"
      ></etools-ajax>
    <etools-ajax endpoint="[[t2fStaticDataEndpoint]]"
      on-success="_handlet2fStaticData"
      loading="{{t2fStaticDataLoading}}"
      on-unauthorized="_redirectToLogin"
      on-forbidden="_redirectToLogin"
      caching-storage="dexie"
      ></etools-ajax>
    <etools-ajax endpoint="[[usersEndpoint]]"
      on-success="_handleUsers"
      loading="{{usersLoading}}"
      params="[[usersEndpointParams]]"
      on-unauthorized="_redirectToLogin"
      on-forbidden="_redirectToLogin"
      caching-storage="dexie"
      ></etools-ajax>
    <etools-ajax endpoint="[[usersEndpoint]]"
      on-success="_handleDrivers"
      loading="{{driversLoading}}"
      params="[[driversEndpointParams]]"
      on-unauthorized="_redirectToLogin"
      on-forbidden="_redirectToLogin"
      caching-storage="dexie"
      ></etools-ajax>
    <etools-ajax endpoint="[[groupsEndpoint]]"
      on-success="_handleGroups"
      loading="{{groupsLoading}}"
      on-unauthorized="_redirectToLogin"
      on-forbidden="_redirectToLogin"
      caching-storage="dexie"
      ></etools-ajax>
    <etools-ajax url="[[vendorEndPoint]]"
      loading="{{vendorNumbersLoading}}"
      on-success="_handleVendorNumbers"
      on-unauthorized="_redirectToLogin"
      on-forbidden="_redirectToLogin"
      caching-storage="dexie"
      ></etools-ajax>
    <etools-ajax url="[[costStructureEndpoint]]"
      loading="{{costStructureLoading}}"
      on-success="_handleCostStructure"
      on-unauthorized="_redirectToLogin"
      on-forbidden="_redirectToLogin"
      caching-storage="dexie"
      ></etools-ajax>

  </template>

  <script>
    Polymer({

      is: 'et2f-structure-data',

      properties: {
        staticDataLoading: Boolean,
        sectionsLoading: Boolean,
        officesLoading: Boolean,
        t2fStaticDataLoading: Boolean,
        driversLoading: Boolean,
        vendorNumbersLoading: Boolean,
        structure: {
          type: Object,
          notify: true,
          computed: '_generateStructure(staticData, sectionsData,' +
          ' officesData, t2fStaticData, usersData, groupsData, driversData, vendorNumbers, wbsGrantsFunds)'
        },
        rawStructure: {
          type: Object,
          notify: true,
          value: {}
        },
        staticData: {
          type: Object,
        },
        sectionData: {
          type: Object
        },
        officesData: {
          type: Object
        },
        wbsGrantsFunds: {
          type: Object
        },
        userBusinessArea: {
          type: Number,
        },
        loading: {
          type: Boolean,
          notify: true,
          computed: '_computeLoading(staticDataLoading, sectionsLoading,' +
          ' officesLoading, t2fStaticDataLoading, usersLoading, groupsLoading, driversLoading, vendorNumbersLoading)'
        },
        staticDataEndpoint: {
          type: String,
          value: etoolsAppConfig.endpoints.staticData
        },
        sectionsEndpoint: {
          type: String,
          value: etoolsAppConfig.endpoints.sections
        },
        officesEndpoint: {
          type: String,
          value: etoolsAppConfig.endpoints.offices
        },
        t2fStaticDataEndpoint: {
          type: String,
          value: etoolsAppConfig.endpoints.t2fStaticDataEndpoint
        },
        usersEndpoint: {
          type: String,
          value: etoolsAppConfig.endpoints.users
        },
        usersEndpointParams: {
          value: {verbosity: 'minimal'}
        },
        driversEndpointParams: {
          value: {verbosity: 'minimal', drivers: 'true'}
        },
        groupsEndpoint: {
          type: String,
          value: etoolsAppConfig.endpoints.groups
        },
        vendorEndPoint: {
          type: String,
          value: etoolsAppConfig.endpoints.et2fVendorList.url
        },
        costStructureEndpoint: {
          type: String,
          computed: '_computeTemporaryBusinessArea(userBusinessArea)'
        },
      },
      behaviors: [et2fBehaviors.ApiBehavior],
      _sortByLabel: function(a, b) {
        return a.label.localeCompare(b.label);
      },
      _sortByName: function(a, b) {
        return a.name.localeCompare(b.name);
      },

      _computeTemporaryBusinessArea: function(userBa) {
        //TODO REMOVE THIS
        // return etoolsAppConfig.endpoints.et2fCostStructure.url + '?business_area=' + userBa;
        return etoolsAppConfig.endpoints.et2fCostStructure.url;
      },

      _computeLoading: function() {
        var result = false;
        for (var i = 0; i < arguments.length; ++i) {
           result = result || arguments[i];
        }
        return result;
      },
      _checkJSON: function(data) {
        if (typeof data === 'string') {
          data = JSON.parse(data);
        }
        return data;
      },
      _redirectToLogin: function() {
        window.location.href = '/login/';
      },
      _handleStaticData: function(e, data) {
        data = this._checkJSON(data);
        var rawData = Object.assign({}, data);
        Object.assign(this.rawStructure, rawData);
        if (!data.parsed) {
          data = this._parseStructureData(data);
        }
        this.set('staticData', data);
      },
      _handleSections: function(e, data) {
        data = this._checkJSON(data);
        var rawData = data.slice();
        Object.assign(this.rawStructure, {sections: rawData});
        if (!data.parsed) {
          data = {
            sections: data.sort(this._sortByName)
          };
          data = this._parseStructureData(data);
        }
        this.set('sectionsData', data);
      },
      _handleOffices: function(e, data) {
        data = this._checkJSON(data);
        var rawData = data.slice();
        Object.assign(this.rawStructure, {offices: rawData});
        if (!data.parsed) {
          data = {
            offices: data.sort(this._sortByName)
          };
          data = this._parseStructureData(data);
        }
        this.set('officesData', data);
      },
      _handlet2fStaticData: function(e, data) {
        data = this._checkJSON(data);
        var rawData = Object.assign({}, data);
        Object.assign(this.rawStructure, rawData);
        if (!data.parsed) {
          data = this._parseStructureData(data);
        }
        this.set('t2fStaticData', data);
      },
      _handleUsers: function(e, data) {
        data = this._checkJSON(data);
        var rawData = data.slice();
        Object.assign(this.rawStructure, {users: rawData});
        if (!data.parsed) {
          data = {
            users: data
          };
          data = this._parseStructureData(data);
        }
        this.set('usersData', data);
      },
      _handleDrivers: function(e, data) {
        data = this._checkJSON(data);
        var rawData = data.slice();
        Object.assign(this.rawStructure, {drivers: rawData});
        if (!data.parsed) {
          data = {
            drivers: data
          };
          data = this._parseStructureData(data);
        }
        this.set('driversData', data);
      },
      _handleVendorNumbers: function(e, data) {
        data = this._checkJSON(data);
        var rawData = data.slice();
        Object.assign(this.rawStructure, {vendorNumbers: rawData});
        if (!data.parsed) {
          data = {
            vendorNumbers: data
          };
          data = this._parseStructureData(data);
        }
        this.set('vendorNumbers', data);
      },
      _handleGroups: function(e, data) {
        data = this._checkJSON(data);
        var rawData = data.slice();
        Object.assign(this.rawStructure, {groups: rawData});
        if (!data.parsed) {
          data = {
            groups: data
          };
          data = this._parseStructureData(data);
        }
        this.set('groupsData', data);
      },
      _handleCostStructure: function(e, data) {
        data = this._checkJSON(data);
        var rawData = Object.assign({}, data);
        Object.assign(this.rawStructure, {
          wbs: rawData.wbs,
          grants: rawData.grants,
          funds: rawData.funds
        });
        if (!data.parsed) {
          data = {
            wbs: data.wbs,
            grants: data.grants,
            funds: data.funds,
          };
          data = this.parseCostStructure(data);
        }
        this.set('wbsGrantsFunds', data);
      },
      _generateStructure: function(static, sections, offices, t2fStaticData, users, groups,
        drivers, vendorNumbers, wbsGrantsFunds) {
          var data = static;
          data.sections = sections.sections;
          data.offices = offices.offices;
          data.locations = t2fStaticData.locations;
          data.results = t2fStaticData.results;
          data.partners = t2fStaticData.partners;
          data.partnerships = t2fStaticData.partnerships;
          data.government_partnerships = t2fStaticData.government_partnerships;
          data.action_point_statuses = t2fStaticData.action_point_statuses;
          data.users = users.users;
          data.groups = groups.groups;
          data.drivers = drivers.drivers;
          data.vendorNumbers = vendorNumbers.vendorNumbers;
          data.wbs = wbsGrantsFunds.wbs;
          data.grants = wbsGrantsFunds.grants;
          data.funds = wbsGrantsFunds.funds;
          data.attachment_types = [
            {value: 0, label: 'Ticket Doc'},
            {value: 1, label: 'Email corespondance'},
            {value: 3, label: 'Cleareance Doc'},
            {value: 4, label: 'Other'}
          ];

          this.set('rawStructure', Object.assign({}, this.rawStructure));
          return data;
      }
    });
  </script>
</dom-module>
