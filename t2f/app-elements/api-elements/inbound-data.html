<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../app-config/etools-app-config.html">


<dom-module id="et2f-inbound-data">
  <template>

    <etools-ajax url="[[travelUrl]]"
      on-success="_handleData" loading="{{loading}}"></etools-ajax>


  </template>

  <script>
    Polymer({

      is: 'et2f-inbound-data',

      properties: {
        et2fData: {
          type: Object,
          notify: true,
        },
        structure: Object,
        travelId: {
          type: String
        },
        travelUrl: {
          type: String,
          computed: '_computeUrl(travelId)',
        },
        dataToSerialize: {
          type: Object,
          observer: '_handleIncomingData'
        },
        loading: {
          type: Boolean,
          notify: true,
        },
        listen: {
          type: Boolean,
          value: true
        },
        route: {
          type: Object,
          notify: true
        }

      },
      behaviors: [et2fBehaviors.ApiBehavior],
      _computeUrl: function(travelId) {
        if (this.listen && travelId && travelId !== -1) {
          return etoolsAppConfig.globals.computeTemplate('et2fTravelDetail', {
            id: travelId
          }).url;
        }
      },

      _handleIncomingData: function(incomingData) {
        this.listen = false;
        var id = incomingData.id;
        this._handleData(null, incomingData);
        var route = this.route;
        var routeFragments = route.path.split('/');
        route.path = (routeFragments.slice(0, routeFragments.length - 1).join('/')) + '/' + id;
        this.set('route', {});
        this.set('route', route);
        this.listen = true;
      },

      _handleData: function(e, incomingData) {
        var self = this;
        // not clear why this function call return an object in
        // the form type - value instead of the object with the value
        var lib = self._structureLib().value;
        var statusLib = {
          'planned': 'Planned',
          'submitted': 'Submitted',
          'approved': 'Approved',
          'rejected': 'Rejected',
          'sent_for_payment': 'Sent for payment',
          'cancelled': 'Cancelled',
          'done': 'Certification needed',
          'certification_approved': 'Certification approved',
          'certification_rejected': 'Certification rejected',
          'certification_submitted': 'Certification submitted',
          'certified': 'Completed',
          'completed': 'Completed'
        };

        var nonBaseKeys = [
          'deductions',
          'itinerary',
          'activities',
          'cost_assignments',
          'expenses',
          'clearances',
          'rejection_note',
          'cert_rejection_note',
          'cancellation_note',
          'certification_note',
          'misc_expenses',
          'canceled_at',
          'completed_at',
          'cancellation_date',
          'completion_date',
          'attachments',
          'cost_summary',
          'report',
          'action_points'
        ];

        var dataKeys = Object.keys(incomingData).filter(function(key) {
          return nonBaseKeys.indexOf(key) === -1;
        });

        incomingData.baseDetails = {};
        dataKeys.forEach(function(key) {
          incomingData.baseDetails[key] = incomingData[key];
          delete incomingData[key];
        });

        function handleObject(fieldSet, key) {
          // loop on the object inner keys
          if (!fieldSet) {
            return;
          }
          var localKeys = Object.keys(fieldSet);
          localKeys.forEach(function(label) {
            // search the structure library for a match

            var structureData = lib[key][label];
            if (structureData) {
               fieldSet[label] = self._processLib(structureData, fieldSet[label]);
            }
          });
        }

        function handleArray(fieldSet, key) {
          if (fieldSet.length === 0 && key !== 'attachments') {
            // add one empty object in case of empty array
            fieldSet.push({});
          } else {
            //loop on array elements and run the object handling function
            fieldSet.forEach(function(innerFieldSet) {
              handleObject(innerFieldSet, key);
            });
          }
        }
        var newKeys = Object.keys(incomingData);
        newKeys.forEach(function(fieldSet) {
          if (incomingData[fieldSet] instanceof Array) {
            handleArray(incomingData[fieldSet], fieldSet);
          } else if (typeof incomingData[fieldSet] === 'object') {
            handleObject(incomingData[fieldSet], fieldSet);
          }
        });

        if (incomingData.baseDetails.status) {
          incomingData.status = statusLib[incomingData.baseDetails.status];
        } else {
          incomingData.status = statusLib.planned;
        }
        this.set('et2fData', {});
        this.set('et2fData', incomingData);
      }
    });
  </script>
</dom-module>
