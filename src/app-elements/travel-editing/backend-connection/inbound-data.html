<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../../../bower_components/etools-loading/etools-loading.html">



<dom-module id="et2f-inbound-data">
  <template>

      <etools-ajax url="[[travelUrl]]"
        on-success="_handleData"></etools-ajax>
    <etools-loading active="[[travelUrl]]"></etools-loading>

  </template>

  <script>
    Polymer({
      is: 'et2f-inbound-data',
      properties: {
        data: {
          type: Object,
          notify: true,
        },
        structure: Object,
        travelId: {
          type: String
        },
        travelUrl: {
          type: String,
          computed: '_computeUrl(travelId)',
          reflectToAttribute: true
        },

      },

      _computeUrl: function(travelId) {
        this.set('data', {});
        var travelId = travelId ? travelId.replace(/\//g, '') : null;
        if(travelId) {
          return etoolsAppConfig.globals.computeTemplate('et2fTravelDetail', {id: travelId}).url
        }
      },
      _handleData: function (e, data) {
        var self = this;

        function convertDate(item) {
          return new Date(item);
        }

        function multiFieldConversion (subField, fieldName, fieldSet) {
          if (fieldSet instanceof Array) {
            return fieldSet.map(function (field) {
              return self.structure[fieldName].find(function (item) {
                return item[subField] === field;
              })
            })
          }
        }

        function matchByLabel (fieldName, item) {
          return self.structure[fieldName].find(function (struct) {
            return struct.label === item;
          })
        }

        var structureLib = {
          baseDetails: {
            traveller: 'users',
            supervisor: 'users',
            office: 'offices',
            section: 'sections',
            start_date: convertDate,
            end_date: convertDate,
            mode_of_travel: multiFieldConversion.bind(this, 'label', 'mode_of_travel'),
            currency: 'currencies',
          },
          activities: {
            locations: multiFieldConversion.bind(this, 'value', 'locations'),
            travel_type: matchByLabel.bind(this, 'mode_of_travel'),
            partner: 'partners',
            partnership: 'partnerships',
            result: 'results',
          },
          itinerary: {
            airlines: multiFieldConversion.bind(this, 'value', 'airlines'),
            mode_of_travel: matchByLabel.bind(this, 'mode_of_travel'),
            dsa_region: 'dsa_regions'
          },
          expenses: {
            type: 'expense_types',
            document_currency: 'currencies',
            account_currency: 'currencies'
          },
          clearances: {},
          deductions: {},
          cost_assignments: {
            wbs: 'wbs',
            grant: 'grants',
            fund: 'funds'
          }


        };
        var statusLib = {
          "planned": "Planned",
          "submitted": "Submitted",
          "approved": "Approved",
          "rejected": "Rejected",
          "sent_for_payment": "Sent for payment",
          "cancelled": "Cancelled",
          "done": "Certification needed",
          "certification_approved": "Certification approved",
          "certification_rejected": "Certification rejected",
          "certification_submitted": "Certification submitted",
          "certified": "Completed",
        };


        var nonBaseKeys = [ 'deductions', 'itinerary', 'activities', 'cost_assignments', 'expenses', 'clearances'];
        var dataKeys = Object.keys(data).filter(function(key){
          return nonBaseKeys.indexOf(key) === -1;
        });
        data.baseDetails = {};
        dataKeys.forEach(function(key) {
          data.baseDetails[key] = data[key];
          delete data[key];
        });

        function handleArray(fieldSet, key) {
          if(fieldSet.length === 0) {
            // add one empty object in case of empty array
            fieldSet.push({});
          } else {
            //loop on array elements and run the object handling function
            fieldSet.forEach(function(innerFieldSet) {
              handleObject(innerFieldSet, key)
            })
          }
        }

        function handleObject(fieldSet, key) {
          // loop on the object inner keys
          if(!fieldSet) {
            return
          }
          var localKeys = Object.keys(fieldSet);
          localKeys.forEach(function(label) {
            // search the structure library for a match
            var structureData = structureLib[key][label];
            if(structureData) {
              //apply the matching function or the transformation from the structure
              if(typeof structureData  === 'function') {
                fieldSet[label] = structureData(fieldSet[label]);
              }
              else {
                fieldSet[label] = self.structure[structureData].find(function (item) {
                  return item.value === fieldSet[label];
                })
              }
            }
          })
        }

        var newKeys = Object.keys(data);
        newKeys.forEach(function (fieldSet) {
          if (data[fieldSet] instanceof Array) {
            handleArray(data[fieldSet], fieldSet);
          }
          else if(typeof data[fieldSet] === 'object'){
            handleObject(data[fieldSet], fieldSet);
          }
        });

        if(data.baseDetails.status) {
          data.status = statusLib[data.baseDetails.status];
        } else {
          data.status = statusLib['planned'];
        }
        this.set('travelId', undefined);
        this.set('data', data);
//        console.log(this.data)
      }
    });
  </script>
</dom-module>
