<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="../../../../styles/et2f-styles.html">

<dom-module id="et2f-outbound-data">

  <style include="shared-styles et2f-styles iron-flex" is="custom-style">

    .dialog-heading {
      font-size: 20px;
      color: var(gray-dark);
      font-weight: 500;
    }

    .dialog-intro-text {
      color: var(--gray-mid);
      font-size: 16px;
      margin-bottom: 24px;
    }

    .row-container {
      width: 250px;
    }

    .small-column-heading {
      font-size: 12px;
      font-weight: 500;
      text-align: center;
    }

    .dialog-confirm-button {
      color: var(--et2f-primary);
      font-weight: 500;
      height: 40px;
      float: right;
    }

    paper-radio-button {
      text-align: center;
      margin-left: 10px;
    }

  </style>

  <template>

    <!-- Crearances dialog -->
    <!-- we're working with the outbound data here, so no older value gets shown for now, although it gets stored -->
    <paper-dialog id="clearance-modal" opened="{{clearancesOpened}}" with-backdrop>

      <div class="dialog-heading">Travel authorization</div>
      <div class="dialog-intro-text">Before you submit this trip for approval, please answer the questions below.</div>

      <div class="layout vertical">

        <div class="layout horizontal center">
          <div class="row-container"></div>
          <div class="flex small-column-heading">Yes</div>
          <div class="flex small-column-heading">No</div>
          <div class="flex small-column-heading">Not Applicable</div>
        </div>

        <div class="layout horizontal center">
          <div class="row-container" id="label-sec-clear">Did you request Security Clearance?</div>
          <paper-radio-group class="flex layout horizontal" selected="{{serverData.clearances.security_clearance}}">
            <paper-radio-button class="flex" name="requested"></paper-radio-button>
            <paper-radio-button class="flex" name="not_requested"></paper-radio-button>
            <paper-radio-button class="flex" name="not_applicable"></paper-radio-button>
          </paper-radio-group>
        </div>

        <div class="layout horizontal center">
          <div class="row-container" id="label-med">Did you request Medical Clearance?</div>
          <paper-radio-group class="flex layout horizontal" selected="{{serverData.clearances.medical_clearance}}">
            <paper-radio-button class="flex" name="requested"></paper-radio-button>
            <paper-radio-button class="flex" name="not_requested"></paper-radio-button>
            <paper-radio-button class="flex" name="not_applicable"></paper-radio-button>
          </paper-radio-group>
        </div>

        <div class="layout horizontal center">
          <div class="row-container" id="label-sec-course">Did you request Security Course?</div>
          <paper-radio-group class="flex layout horizontal" selected="{{serverData.clearances.security_course}}">
            <paper-radio-button class="flex" name="requested"></paper-radio-button>
            <paper-radio-button class="flex" name="not_requested"></paper-radio-button>
            <paper-radio-button class="flex" name="not_applicable"></paper-radio-button>
          </paper-radio-group>
        </div>
      </div>

      <paper-button
              class="dialog-confirm-button"
              on-click="_clearancesOnConfirm">
        Submit for approval
      </paper-button>
    </paper-dialog>

    <!-- Rejection dialog -->
    <paper-dialog id="rejection-modal" opened="{{rejectionOpened}}" with-backdrop>

      <div class="dialog-heading">Reject travel</div>
      <div class="dialog-intro-text">Please specify reasons for rejecting this travel:</div>

      <!-- TODO: save, display somewhere -->
      <paper-textarea label="Rejection note" value="{{serverData.rejection_note}}" char-counter maxlength="2500"></paper-textarea>

      <paper-button
              class="dialog-confirm-button"
              on-click="_rejectOnConfirm">
        Send rejection
      </paper-button>
    </paper-dialog>

    <!-- Cancellation dialog -->
    <paper-dialog id="cancel-modal" opened="{{cancellationOpened}}" with-backdrop>

      <div class="dialog-heading">Cancel travel</div>
      <div class="dialog-intro-text">Please specify reasons for cancelling this travel:</div>

      <!-- TODO: save, display somewhere -->
      <paper-textarea label="Cancellation note" value="{{serverData.cancellation_note}}" char-counter maxlength="2500"></paper-textarea>

      <paper-button
              class="dialog-confirm-button"
              on-click="_cancelOnConfirm">
        Cancel travel
      </paper-button>
    </paper-dialog>

    <!-- Certification dialog -->
    <etools-dialog opened="{{certificationOpened}}"
                   dialog-title="Certify"
                   ok-btn-text="Send certification"
                   on-close="_certifyOnClose">

      <!-- TODO: wire in, save, display somewhere -->
      <paper-textarea label="Certification" char-counter maxlength="2500"></paper-textarea>
    </etools-dialog>


    <etools-loading active="[[loading]]"></etools-loading>


    <template is="dom-if" if="[[postData]]">
      <etools-ajax endpoint="[[postEndpoint]]"
                   body="[[serverData]]"
                   method="[[method]]"
                   on-success="_handlePostSuccess"
                   on-fail="_handlePostFail"></etools-ajax>
    </template>

    <template is="dom-if" if="[[attachmentData]]">
      <etools-ajax endpoint="[[attachmentsEndpoint]]"
                   body="[[attachment]]"
                   method="POST"
                   multi-part
                   on-success="_handleAttachmentPostSuccess"
                   on-fail="_handlePostFail"></etools-ajax>
    </template>


  </template>

  <script>
    Polymer({
      is: 'et2f-outbound-data',
      properties: {
        data: {
          type: Object,
          notify: true,
        },
        structure: {
          type: Object,
        },
        newTravel: {
          type: Boolean,
          value: false
        },
        travelId: {
          type: String,
          notify: true
        },
        loading: {
          type: Boolean,
          computed: '_computeLoading(postData, attachmentData)'
        },
        postData: {
          type: Boolean,
          value: false
        },
        attachmentData: {
          type: Boolean,
          value: false
        },
        serverData: {
          type: Object,
          value: function () {
            return {}
          }
        },
        attachmentsEndpoint: {
          type: String,
          computed: '_computeAttachmentsEndpoint(travelId)'
        }
      },
      _computeAttachmentsEndpoint: function(travelId) {
        return etoolsAppConfig.globals.computeTemplate('et2fTravelAttachments', {id: travelId})
      },
      _computeLoading: function(post, attachment){
        return post || attachment
      },

      _processOutboundData: function (data) {
        var self = this;
        delete data.status;
        this.serverData = {
          deductions: [],
          itinerary: [],
          activities: [],
          cost_assignments: [],
          expenses: [],
          clearances: {}
        };

        function duplicateIdPurging(collection) {
          if(collection.length < 2) {
            return collection;
          }
          return collection.reduce(function(prev, current) {
            if(prev.some(function(prevItem){return prevItem.id === current.id;})) {
              delete current.id;
            }
            prev.push(current);
            return prev;
          }, [])
        }

        function emptyIdPurging(collection) {
          return collection.map(function(item) {
            if(item && item.id === '') {
              delete item.id
            }
            return item;
          })
        }

        function handleArray(arr) {
          arr = duplicateIdPurging(arr);
          arr = emptyIdPurging(arr);
          arr.forEach(function(obj) {
            handleObject(obj);
          });
        }


        function handleObject(obj) {
          if (!obj) {return;}
          var keys = Object.keys(obj);
          keys.forEach(function(key) {
            if(obj[key] && !(obj[key] instanceof Array )){
              obj[key] = typeof obj[key] === 'object' ? key === 'travel_type' || key === 'mode_of_travel' ? obj[key].label : obj[key].value : obj[key]
            }
            if(obj[key] && obj[key] instanceof Array ){
              obj[key] = obj[key].map(function(item) {
                if(key === 'mode_of_travel') {
                  return item.label;
                }
                return typeof  item === 'object' ? item.value : item
              })
            }
          });
        }

        var dataKeys = Object.keys(data);

        dataKeys.forEach(function(fieldSet){
          if (data[fieldSet] instanceof Array) {
            handleArray(data[fieldSet])
          }
          else if(typeof data[fieldSet] === 'object'){
            handleObject(data[fieldSet]);
          }
        });

        var serverKeys = Object.keys(this.serverData);


        serverKeys.forEach(function(serverKey) {
          if(data[serverKey] instanceof Array && data[serverKey][0]) {
            if(Object.keys(data[serverKey][0]).length === 0) {
              delete self.serverData[serverKey];
            }
          }
          if(self.serverData[serverKey]) {
            self.serverData[serverKey] = data[serverKey];
          }
          delete data[serverKey];
        });

        var leftoverKeys = Object.keys(data);
        leftoverKeys.forEach(function(key) {
          if (!data[key]) { return; }
          var innerKeys = Object.keys(data[key]);
          innerKeys.forEach(function(innerKey) {
            self.serverData[innerKey] = data[key][innerKey];
          })

        });
      },
      _processAttachmentData: function(data) {
        this.attachments = data.attachments;
        delete data.attachments;

      },
      doRequest: function (details) {
        this._processAttachmentData(this.data);
        this._processOutboundData(this.data);
        var self = this;
        var endpointConfig = {
          id: self.travelId ? self.travelId.replace(/\//g, '') : null,
          status: null
        };
        var endpointName = 'et2fStateChange';

        function doSavePost() {
          self.method = 'POST';
          self.postEndpoint = etoolsAppConfig.endpoints.et2fTravelList;
          self.postData = true;
        }

        function doSaveAndSubmit() {
          self.method = 'POST';
          self.postEndpoint = etoolsAppConfig.endpoints.et2fSaveAndSubmit;
          self.postData = true;
        }

        function doSaveUpdate() {
          self.method = 'PATCH';
          self.postEndpoint = etoolsAppConfig.endpoints.et2fTravelDetail;
          self.postData = true;
        }

        function doPut() {
          self.method = 'PUT';
          self.postEndpoint = etoolsAppConfig.globals.computeTemplate(endpointName, endpointConfig);
          self.postData = true;
        }

        function doPost() {
          self.method = 'POST';
          self.postEndpoint = etoolsAppConfig.globals.computeTemplate(endpointName, endpointConfig);
          self.postData = true;
        }

        var statusActions = {

          save: function () {
            if(self.travelId !== undefined) {
              doSaveUpdate();
            } else {
              doSavePost()
            }
          },

          save_and_submit: function() {

            self.set('serverData.clearances', {
              medical_clearance: 'not_applicable',
              security_clearance: 'not_applicable',
              security_course: 'not_applicable'
            });

            self._clearancesOnConfirm = function () {

              self.$['clearance-modal'].close();
              if (endpointConfig.id) {
                endpointConfig.status = 'submit_for_approval';
                doPost();
              } else {
                endpointConfig.status = 'save_and_submit';
                doSaveAndSubmit();
              }
            };
            self.clearancesOpened = true;
          },

          // TODO: Cancel popup
          cancel: function() {

            self._cancelOnConfirm = function() {

              self.$['cancel-modal'].close();
              if(self.travelId !== undefined) {
                endpointConfig.status = 'cancel';
                doPost();
              } else {
                this._handlePostSuccess();
              }
            }

            self.cancellationOpened = true;
          },

          // TODO: Approve popup
          approve: function() {
            endpointConfig.status = 'approve';
            doPost();
          },

          reject: function() {
            self._rejectOnConfirm = function() {
              self.$['rejection-modal'].close();

              endpointConfig.status = 'reject';
              doPost();
            }
            self.rejectionOpened = true;
          },

          // TODO: Reopen popup
          reopen: function() {
            endpointConfig.status = 'restore';
            doPost();
          },

          // Send for payment popup
          send_for_payment: function() {
            endpointConfig.status = 'send_for_payment';
            doPost();
          },

          went_as_planned: function() {
            endpointConfig.status = 'mark_as_certified';
            doPost();
          },

          submit_certificate: function() {

            self.certificationOpened = true;
            self._certifyOnClose = function() {

              endpointConfig.status = 'submit_certificate';
              doPost();
            }
          },

          done: function() {
            console.log('Mark as done fn. ran!');
            endpointConfig.status = 'done';
            doMarkAsDone();
          },

          // TEST
          approve_certificate: function() {
            endpointConfig.status = 'approve_certificate';
            doPost();
          },

          // TEST
          // TODO: Raise modal
          reject_certificate: function() {
            console.log('TODO!!');
            endpointConfig.status = 'reject_certificate';
            doPost();
          },

          // TEST
          certify: function() {
            endpointConfig.status = 'mark_as_certified';
            doPost();
          },

          // TEST
          complete: function() {
            endpointConfig.status = 'done';
            doPost();
          },

          // TEST
          planned: function() {
            endpointConfig.status = 'plan';
            doPost();
          }
        };

        statusActions[details.endPoint]();

      },
      _doAttachmentUpload: function() {
        var current = this.attachments.pop();

        this.attachment = {
          name: current.file_name,
          file: current.raw,
          type: current.type ? current.type.label : 'Report'
        };
        this.attachmentData = true;
      },
      _handlePostFail: function(event, i) {
        var self = this;
        this.formError = i.request.detail.request.xhr.response;
        if (!this.formError) {return}
        Object.keys(this.formError).forEach(function(key) {
          console.error(key + 'error: ', self.formError[key])
        });
        this.postData = false;
        this.attachmentData = false;
      },

      _handleAttachmentPostSuccess: function (e, data) {
        if(this.attachments.length > 0 ) {
          this.travelId =  this.travelId ? this.travelId : '' + data.id;
          this._doAttachmentUpload();
        }
        else {
          this.fire('travel-post-success', data);
          var travelId = this.travelId;
          this.travelId = null;
          this.travelId = travelId;
        }
      },

      _handlePostSuccess: function(e, data) {
        this.postData = false;
        if(this.attachments.length > 0 ) {
          this.travelId =  this.travelId ? this.travelId : '' + data.id;
          this._doAttachmentUpload();
        }
        else {
          this.fire('travel-post-success', data);
          this.travelId = null;
          this.travelId = '' + data.id
        }
      },


    });
  </script>
</dom-module>
