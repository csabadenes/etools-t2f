<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../../bower_components/etools-loading/etools-loading.html">
<link rel="import" href="../../../bower_components/etools-dialog/etools-dialog.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="travel-details.html">
<link rel="import" href="travel-attachments.html">
<link rel="import" href="travel-report.html">
<link rel="import" href="../et2f-header.html">

<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/et2f-styles.html">

<dom-module id="travel-edit">
  <template>
    <style include="shared-styles et2f-styles iron-flex iron-flex-alignment iron-flex-factors">
      :host {
        display: block;
        width: 100%;
        background-color: var(--gray-lighter);
      }

      #label-sec-clear, #label-med, #label-sec-course {
        display: inline-block;
        width: 220px;
      }
    </style>


    <etools-loading active="[[postData]]"></etools-loading>

    <template is="dom-if"
      if="{{travelId}}">
      <etools-ajax url="[[travelUrl]]"
        on-success="_handleData"></etools-ajax>
    </template>

    <template is="dom-if"
      if="[[postData]]">
      <etools-ajax endpoint="[[postEndpoint]]"
        body="[[serverData]]"
        method="[[method]]"
        on-success="_handlePostSuccess"
        on-fail="_handlePostFail"></etools-ajax>
    </template>

    <!-- Crearances dialog -->
    <etools-dialog opened="{{clearancesOpened}}"
      dialog-title="Clearances"
      ok-btn-text="Submit for approval"
      on-close="_clearancesOnClose">

      <!-- TODO: wire in -->
      <!-- TODO: prefill data on empty one & serialize it -->
      <!-- TODO: hide no button -->
      <!-- TODO: style it -->
      <div>Before you submit this trip for approval, please answer the questions below.</div>

      <div class="layout vertical">

        <div>
          <label id="label-sec-clear">Did you request Security Clearance?</label>
          <paper-radio-group aria-labelledby="label-sec-clear">
            <paper-radio-button name="medical_clearance"></paper-radio-button>
            <paper-radio-button name="security_clearance"></paper-radio-button>
            <paper-radio-button name="security_course"></paper-radio-button>
          </paper-radio-group>
        </div>

        <div>
          <label id="label-med">Did you request Medical Clearance?</label>
          <paper-radio-group aria-labelledby="label-med">
            <paper-radio-button name="medical_clearance"></paper-radio-button>
            <paper-radio-button name="security_clearance"></paper-radio-button>
            <paper-radio-button name="security_course"></paper-radio-button>
          </paper-radio-group>
        </div>

        <div>
          <label id="label-sec-course">Did you request Security Course?</label>
          <paper-radio-group aria-labelledby="label-sec-course">
            <paper-radio-button name="medical_clearance"></paper-radio-button>
            <paper-radio-button name="security_clearance"></paper-radio-button>
            <paper-radio-button name="security_course"></paper-radio-button>
          </paper-radio-group>
        </div>
      </div>
    </etools-dialog>

    <!-- Rejection dialog -->
    <etools-dialog opened="{{rejectionOpened}}"
      dialog-title="Reject travel"
      ok-btn-text="Send rejection"
      on-close="_rejectOnClose">

      <!-- TODO: wire in, save, display somewhere -->
      <paper-textarea label="Rejection note" char-counter maxlength="2500"></paper-textarea>
    </etools-dialog>

    <!-- Certification dialog -->
    <etools-dialog opened="{{certificationOpened}}"
      dialog-title="Certify"
      ok-btn-text="Send certification"
      on-close="_certifyOnClose">

      <!-- TODO: wire in, save, display somewhere -->
      <paper-textarea label="Certification" char-counter maxlength="2500"></paper-textarea>
    </etools-dialog>

    <et2f-header title="Edit travel plan">
      <paper-tabs scrollable
        selected="{{selected}}">
        <paper-tab>Travel details</paper-tab>
        <paper-tab>Attachments</paper-tab>
        <paper-tab>Report</paper-tab>
      </paper-tabs>
    </et2f-header>

    <iron-pages selected="{{selected}}">

      <travel-details
        structure="[[structure]]"
        travel-permissions="[[travelPermissions]]"
        data="{{data}}"
        on-form-action="_handleFormAction">
      </travel-details>

      <travel-attachments></travel-attachments>

      <travel-report
        structure="[[structure]]"
        et2f-permissions="[[et2fPpermissions]]"
        data="{{data}}"
        on-form-action="_handleFormAction">
      </travel-report>
    </iron-pages>

  </template>

  <script>
    Polymer({
      is: 'travel-edit',
      properties: {
        data: {
          type: Object,
          notify: true,
        },
        structure: {
          type: Object,
        },
        et2fPermissions: {
          type: Object
        },
        status: {
          type: String,
          computed: '_computeStatus(data)'
        },
        user: {
          type: Object,
        },
        travelPermissions: {
          type: Object,
          notify: true,
          computed: '_computeTravelPermission(et2fPermissions, status, user, data)'
        },
        selected: {
          type: Number,
          value: 0
        },
        newTravel: {
          type: Boolean,
          value: false
        },
        travelId: {
          type: String
        },
        travelUrl: {
          type: String,
          computed: '_computeUrl(travelId)',
          reflectToAttribute: true
        },
        postData: {
          type: Boolean,
          value: false
        },
        serverData: {
          type: Object,
          value: function () {
            return {}
          }
        }
      },
      observers: ['_dataObserver(data, user)'],
      _computeUrl: function(travelId) {
        this.set('data', {});
        this._resetData();
        var travelId = travelId ? travelId.replace(/\//g, '') : null;
        if(travelId) {
          return etoolsAppConfig.globals.computeTemplate('et2fTravelDetail', {id: travelId}).url
        }
      },
      _computeStatus: function(data) {
        if(data.status) {
          return data.status.toLowerCase();
        }
      },
      _computeTravelPermission: function(permissions, status, user, data) {
        var userType = undefined;
        if(data.baseDetails.id) {
          userType = data.baseDetails.traveller.value === user.id ? 'Traveler' : data.baseDetails.supervisor.value === user.id ? 'Supervisor' : 'Anyone'
        } else
          if(this.newTravel) {
          userType = 'Traveler';
        }
//        userType = 'God';
        if(userType) {
          return permissions[userType][status];
        }
      },

      _handleData: function (e, data) {
        var self = this;

        function convertDate(item) {
          return new Date(item);
        }

        function multiFieldConversion (subField, fieldName, fieldSet) {
          if (fieldSet instanceof Array) {
            return fieldSet.map(function (field) {
              return self.structure[fieldName].find(function (item) {
                return item[subField] === field;
              })
            })
          }
        }

        function matchByLabel (fieldName, item) {
          return self.structure[fieldName].find(function (struct) {
            return struct.label === item;
          })
        }

        var structureLib = {
          baseDetails: {
            traveller: 'users',
            supervisor: 'users',
            office: 'offices',
            section: 'sections',
            start_date: convertDate,
            end_date: convertDate,
            mode_of_travel: multiFieldConversion.bind(this, 'label', 'mode_of_travel'),
            currency: 'currencies',
          },
          activities: {
            locations: multiFieldConversion.bind(this, 'value', 'locations'),
            travel_type: matchByLabel.bind(this, 'mode_of_travel'),
            partner: 'partners',
            partnership: 'partnerships',
            result: 'results',
          },
          itinerary: {
            airlines: multiFieldConversion.bind(this, 'value', 'airlines'),
            mode_of_travel: matchByLabel.bind(this, 'mode_of_travel'),
            dsa_region: 'dsa_regions'
          },
          expenses: {
            type: 'expense_types',
            document_currency: 'currencies',
            account_currency: 'currencies'
          },
          clearances: {},
          deductions: {},
          cost_assignments: {
            wbs: 'wbs',
            grant: 'grants',
            fund: 'funds'
          }


        };
        var statusLib = {
          "planned": "Planned",
          "submitted": "Submitted",
          "approved": "Approved",
          "rejected": "Rejected",
          "sent_for_payment": "Sent for payment",
          "cancelled": "Cancelled",
          "done": "Certification needed",
          "certification_approved": "Certification approved",
          "certification_rejected": "Certification rejected",
          "certification_submitted": "Certification submitted",
          "certified": "Completed",
        };


        var nonBaseKeys = [ 'deductions', 'itinerary', 'activities', 'cost_assignments', 'expenses', 'clearances'];
        var dataKeys = Object.keys(data).filter(function(key){
          return nonBaseKeys.indexOf(key) === -1;
        });
        data.baseDetails = {};
        dataKeys.forEach(function(key) {
          data.baseDetails[key] = data[key];
          delete data[key];
        });

        function handleArray(fieldSet, key) {
          if(fieldSet.length === 0) {
            // add one empty object in case of empty array
            fieldSet.push({});
          } else {
            //loop on array elements and run the object handling function
            fieldSet.forEach(function(innerFieldSet) {
              handleObject(innerFieldSet, key)
            })
          }
        }

        function handleObject(fieldSet, key) {
          // loop on the object inner keys
          if(!fieldSet) {
            return
          }
          var localKeys = Object.keys(fieldSet);
          localKeys.forEach(function(label) {
            // search the structure library for a match
            var structureData = structureLib[key][label];
            if(structureData) {
              //apply the matching function or the transformation from the structure
              if(typeof structureData  === 'function') {
                fieldSet[label] = structureData(fieldSet[label]);
              }
              else {
                fieldSet[label] = self.structure[structureData].find(function (item) {
                  return item.value === fieldSet[label];
                })
              }
            }
          })
        }

        var newKeys = Object.keys(data);
        newKeys.forEach(function (fieldSet) {
          if (data[fieldSet] instanceof Array) {
            handleArray(data[fieldSet], fieldSet);
          }
          else if(typeof data[fieldSet] === 'object'){
            handleObject(data[fieldSet], fieldSet);
          }
        });

        if(data.baseDetails.status) {
          data.status = statusLib[data.baseDetails.status];
        } else {
          data.status = statusLib['planned'];
        }
        this.set('data', data);
      },

      _processOutboundData: function (data) {
        var self = this;
        delete data.status;
        this.serverData = {
          deductions: [],
          itinerary: [],
          activities: [],
          cost_assignments: [],
          expenses: [],
          clearances: {}
        };

        function duplicateIdPurging(collection) {
          if(collection.length < 2) {
            return collection;
          }
          return collection.reduce(function(prev, current) {
            if(prev.some(function(prevItem){return prevItem.id === current.id;})) {
              delete current.id;
            }
            prev.push(current);
            return prev;
          }, [])
        }

        function handleArray(arr) {
          arr = duplicateIdPurging(arr);
          arr.forEach(function(obj) {
            handleObject(obj);
          });
        }


        function handleObject(obj) {
          if (!obj) {return;}
          var keys = Object.keys(obj);
          keys.forEach(function(key) {
            if(obj[key] && !(obj[key] instanceof Array )){
              obj[key] = typeof obj[key] === 'object' ? key === 'travel_type' || key === 'mode_of_travel' ? obj[key].label : obj[key].value : obj[key]
            }
            if(obj[key] && obj[key] instanceof Array ){
              obj[key] = obj[key].map(function(item) {
                if(key === 'mode_of_travel') {
                  return item.label;
                }
                return typeof  item === 'object' ? item.value : item
              })
            }
          });
        }

        var dataKeys = Object.keys(data);

        dataKeys.forEach(function(fieldSet){
          if (data[fieldSet] instanceof Array) {
            handleArray(data[fieldSet])
          }
          else if(typeof data[fieldSet] === 'object'){
            handleObject(data[fieldSet]);
          }
        });

        var serverKeys = Object.keys(this.serverData);


        serverKeys.forEach(function(serverKey) {
          if(data[serverKey] instanceof Array && data[serverKey][0]) {
            if(Object.keys(data[serverKey][0]).length === 0) {
              delete self.serverData[serverKey];
            }
          }
          if(self.serverData[serverKey]) {
            self.serverData[serverKey] = data[serverKey];
          }
          delete data[serverKey];
        });

        var leftoverKeys = Object.keys(data);
        leftoverKeys.forEach(function(key) {
          if (!data[key]) { return; }
          var innerKeys = Object.keys(data[key]);
          innerKeys.forEach(function(innerKey) {
            self.serverData[innerKey] = data[key][innerKey];
          })

        });
      },

      _handleFormAction: function (e, details) {
        this._processOutboundData(this.data);
        var self = this;
        var endpointConfig = {
          id: self.travelId ? self.travelId.replace(/\//g, '') : null,
          status: null
        };
        var endpointName = 'et2fStateChange';

        function doSavePost() {
          self.method = 'POST';
          self.postEndpoint = etoolsAppConfig.endpoints.et2fNewTravel;
          self.postData = true;
        }

        function doSaveAndSubmit() {
          self.method = 'POST';
          self.postEndpoint = etoolsAppConfig.endpoints.et2fSaveAndSubmit;
          self.postData = true;
        }

        function doSaveUpdate() {
          self.method = 'PATCH';
          self.postEndpoint = etoolsAppConfig.endpoints.et2fTravelDetail
          self.postData = true;
        }

        function doPut() {
          self.method = 'PUT';
          self.postEndpoint = etoolsAppConfig.globals.computeTemplate(endpointName, endpointConfig);
          self.postData = true;
        }

        function doPost() {
          self.method = 'POST';
          self.postEndpoint = etoolsAppConfig.globals.computeTemplate(endpointName, endpointConfig);
          self.postData = true;
        }

        var statusActions = {

          save: function () {
            if(self.travelId !== undefined) {
              doSaveUpdate();
            } else {
              doSavePost()
            }
          },

          save_and_submit: function() {

            self.clearancesOpened = true;
            self._clearancesOnClose = function () {
              self.serverData.clearances = {
                medical_clearance: true,
                security_clearance: true,
                security_course: true
              };
              if (endpointConfig.id) {
                endpointConfig.status = 'submit_for_approval';
                doPost();
              } else {
                endpointConfig.status = 'save_and_submit';
                doSaveAndSubmit();
              }
            }
          },

          // TODO: Cancel popup
          cancel: function() {
            if(self.travelId !== undefined) {
              endpointConfig.status = 'cancel';
              doPost();
            } else {
              this._handlePostSuccess();
            }
          },

          // TODO: Approve popup
          approve: function() {
            endpointConfig.status = 'approve';
            doPost();
          },

          reject: function() {
            self.rejectionOpened = true;
            self._rejectOnClose = function() {
              // TODO: wire in note from modal!!!
              self.serverData.rejection_note = 'Some rejection note';

              endpointConfig.status = 'reject';
              doPost();
            }
          },

          // TODO: Reopen popup
          reopen: function() {
            endpointConfig.status = 'restore';
            doPost();
          },

          // Send for papxment popup
          send_for_payment: function() {
            endpointConfig.status = 'send_for_payment';
            doPost();
          },

          went_as_planned: function() {
            endpointConfig.status = 'mark_as_certified';
            doPost();
          },

          submit_certificate: function() {

            self.certificationOpened = true;
            self._certifyOnClose = function() {

              endpointConfig.status = 'submit_certificate';
              doPost();
            }
          },

          done: function() {
            console.log('Mark as done fn. ran!');
            endpointConfig.status = 'done';
            doMarkAsDone();
          },

          // TEST
          approve_certificate: function() {
            endpointConfig.status = 'approve_certificate';
            doPost();
          },

          // TEST
          // TODO: Raise modal
          reject_certificate: function() {
            console.log('TODO!!');
            endpointConfig.status = 'reject_certificate';
            doPost();
          },

          // TEST
          certify: function() {
            endpointConfig.status = 'mark_as_certified';
            doPost();
          },

          // TEST
          complete: function() {
            endpointConfig.status = 'done';
            doPost();
          },

          // TEST
          planned: function() {
            endpointConfig.status = 'plan';
            doPost();
          }
        };

        statusActions[details.endPoint]();

      },
      _handlePostFail: function(event, i) {
        var self = this;
        this.formError = i.request.detail.request.xhr.response;
        if (!this.formError) {errorKey = []};
        errorKey = Object.keys(this.formError);
        errorKey.forEach(function(key) {
          console.error(key + 'error: ', self.formError[key])
        });
        this.postData = false;
      },
      _handlePostSuccess: function() {
        this.postData = false;
        this.fire('travel-post-success');
        this.travelId = null;
        this._resetData();
      },
      _resetData: function() {
        this.data = {
          baseDetails: {},
          activities: [{}],
          itinerary: [{}],
          expenses: [{}],
          deductions: [],
          cost_assignments: [{}],
          status: 'Planned'
        };

      },
      _dataObserver: function(data, user) {
        var self = this;
        if (self.newTravel && data.baseDetails) {
          data.baseDetails.traveller = {
            label: user.full_name,
            value: user.id
          };
          self.notifyPath('data.baseDetails.traveller');
        }

      },
      ready: function () {
        if (this.newTravel) {
          this._resetData();
        }
      }
    });
  </script>
</dom-module>
