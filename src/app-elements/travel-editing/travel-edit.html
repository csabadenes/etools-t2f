<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../../bower_components/etools-loading/etools-loading.html">
<link rel="import" href="../../../bower_components/etools-dialog/etools-dialog.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="travel-details.html">
<link rel="import" href="travel-attachments.html">
<link rel="import" href="travel-report.html">
<link rel="import" href="./backend-connection/inbound-data.html">
<link rel="import" href="./backend-connection/outbound-data.html">
<link rel="import" href="../et2f-header.html">

<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/et2f-styles.html">

<dom-module id="travel-edit">
  <template>
    <style include="shared-styles et2f-styles iron-flex iron-flex-alignment iron-flex-factors">
      :host {
        display: block;
        width: 100%;
        background-color: var(--gray-lighter);
      }

      #label-sec-clear, #label-med, #label-sec-course {
        display: inline-block;
        width: 220px;
      }
    </style>


    <etools-loading active="[[postData]]"></etools-loading>

    <et2f-inbound-data data="{{data}}" travel-id="[[travelId]]" structure="[[structure]]"></et2f-inbound-data>
    <et2f-outbound-data id="outbound-data" data="{{data}}" travel-id="[[travelId]]" structure="[[structure]]"></et2f-outbound-data>

    <et2f-header title="Edit travel plan"
      data-to-print="[[dataToPrint]]"
      print-styles="[[printStyles]]">
      <paper-tabs scrollable
        selected="{{selected}}">
        <paper-tab>Travel details</paper-tab>
        <paper-tab>Attachments</paper-tab>
        <paper-tab>Report</paper-tab>
      </paper-tabs>
    </et2f-header>

    <iron-pages selected="{{selected}}">

      <travel-details
        structure="[[structure]]"
        travel-permissions="[[travelPermissions]]"
        data="{{data}}"
        on-form-action="_handleFormAction">
      </travel-details>

      <travel-attachments></travel-attachments>

      <travel-report
        structure="[[structure]]"
        et2f-permissions="[[et2fPpermissions]]"
        data="{{data}}"
        on-form-action="_handleFormAction">
      </travel-report>
    </iron-pages>

  </template>

  <script>
    Polymer({
      is: 'travel-edit',
      properties: {
        data: {
          type: Object,
          notify: true,
        },
        structure: {
          type: Object,
        },
        et2fPermissions: {
          type: Object
        },
        status: {
          type: String,
          computed: '_computeStatus(data)'
        },
        user: {
          type: Object,
        },
        travelPermissions: {
          type: Object,
          notify: true,
        },
        selected: {
          type: Number,
          value: 0
        },
        newTravel: {
          type: Boolean,
          value: false,
          observer: '_newTravelObserver'
        },
        travelId: {
          type: String
        },
        postData: {
          type: Boolean,
          value: false
        },
        serverData: {
          type: Object,
          value: function () {
            return {}
          }
        },
        dataToPrint: {
          type: Object,
          computed: '_computeDataToPrint(data)',
          notify: true
        },
        printStyles: {
          type: Object,
          computed: '_computeStyles(data)'
        }
      },
      observers: [
        '_dataObserver(data, user)',
        '_computeTravelPermission(et2fPermissions, status, user, data)'
      ],
      _computeStyles: function() {
        return {
          mainHeader: {
            fontSize: 16,
            bold: true,
            color: '#FFFFFF',
            fillColor: '#000000'
          },
          checkbox: {
            bold: true,
            color: '#FFFFFF',
            fillColor: '#000000'
          },
          rightAlign: {
            alignment: 'right'
          }
        }
      },
      _computeDataToPrint(data){
        if(!data.baseDetails) {
          return
        }
        console.log(data);
        var dataToPrint = [];
        var innerTableVars = {
          widths: [380, 380],
          margin: [-5,0],
          innerWidths: [187,187],
          layout: 'lightHorizontalLines',
          noTopLayout: {
            hLineWidth: function(i, node) {
              return (i === 0 ) ? 0 : 1;
            },
            vLineWidth: function(i, node) {
              return 1
            },
            hLineColor: 'black',
            vLineColor: 'black'
          },
          onlyHorizontalDivider: {
            hLineWidth: function(i, node) {
              return (i === 0 || i === node.table.body.length ) ? 0 : 1;
            },
            vLineWidth: function(i, node) {
              return 0
            },
            hLineColor: 'black',
            vLineColor: 'black'
          },
          noVerticalNoTop: {
            hLineWidth: function(i, node) {
              return (i === 0 ) ? 0 : 1;
            },
            vLineWidth: function(i, node) {
              return (i === 0 || i === node.table.widths.length ) ? 1 : 0;
            },
            hLineColor: 'black',
            vLineColor: 'black'
          }
        };

        function innerColumnGen(label, value) {
          return [{text: label + ': ', margin:[5,0]}, {text: '' + value, style: 'rightAlign', margin:[5,0]}]
        }
        function concatManyToMany(value) {
          if(value instanceof Array) {
            return value.reduce(function (prev, cur, index) {
              var tail = index === value.length - 1 ? '' : ',';
              return prev + cur.label + tail
            }, '')
          }
          return '';
        }
        var titleLib = {
          baseDetails: {
            name: 'Travel Plan',
            generator: function() {
              return {
                stack: [
                  {
                    table: {
                      widths: [710, 50],
                      body: [
                        [{text: 'International Travel'}, {text: data.baseDetails.international_travel ? 'YES': 'NO', style: 'checkbox'}]
                      ]
                    },
                  },
                  {
                    layout: innerTableVars.noTopLayout,
                    table: {
                      widths: innerTableVars.widths,
                      body: [
                        [
                          {
                            margin: innerTableVars.margin,
                            layout: innerTableVars.onlyHorizontalDivider,
                            table:{
                              widths: innerTableVars.innerWidths,
                              body: [
                                innerColumnGen('Reference Number', data.baseDetails.reference_number),
                                innerColumnGen('Traveller', data.baseDetails.traveller ? data.baseDetails.traveller.label : ''),
                                innerColumnGen('Start Date', data.baseDetails.start_date),
                                innerColumnGen('Est. Travel cost', data.baseDetails.estimated_travel_cost),
                              ]
                            }
                          },
                          {
                            margin: innerTableVars.margin,
                            layout: innerTableVars.onlyHorizontalDivider,
                            table:{
                              widths: innerTableVars.innerWidths,
                              body: [
                                innerColumnGen('Travel Status', data.baseDetails.status),
                                innerColumnGen('Supervisor', data.baseDetails.supervisor ? data.baseDetails.supervisor.label : ''),
                                innerColumnGen('End date', data.baseDetails.end_date),
                                innerColumnGen('Mode of travel', concatManyToMany(data.baseDetails.mode_of_travel)),
                              ]
                            }
                          }
                        ]

                      ]
                    }
                  },
                  {
                    layout: innerTableVars.noVerticalNoTop,
                    table: {
                      widths: [100, 661],
                      body: [
                        [{text: 'Purpose of travel: '}, {text: data.baseDetails.purpose}]
                      ]
                    },
                  }
                ]
              };
            }
          },
          activities: {
            name: 'Travel Activities (' + data.activities.length + ')' ,
            generator: function() {
              var mainStack = data.activities.map(function(activity, index) {
                console.log(activity)
                return {
                  stack: [
                    {
                      margin: [-25, 0],
                      table: {
                        widths: [16, 380, 321, 50],
                        body: [
                          [
                            {text: '' + (index + 1 ), style: 'checkbox'},
                            {
                              columns: [
                                {text: 'Travel type: '},
                                {text: '' + activity.travel_type, style: 'rightAlign'}
                              ]
                            },
                            {text: 'Primary Traveler?'},

                            {text: activity.primary_traveler ? 'YES' : 'NO' + '', style: 'checkbox'}
                          ],
                        ]
                      },
                    },
                    {
                      layout: innerTableVars.noTopLayout,
                      table: {
                        widths: innerTableVars.widths,
                        body: [
                          [
                            {
                              margin: innerTableVars.margin,
                              layout: innerTableVars.onlyHorizontalDivider,
                              table:{
                                widths: innerTableVars.innerWidths,
                                body: [
                                  innerColumnGen('Partner', activity.partner ? activity.partner.label  : ''),
                                  innerColumnGen('When?', activity.date),
                                ]
                              }
                            },
                            {
                              margin: innerTableVars.margin,
                              layout: innerTableVars.onlyHorizontalDivider,
                              table:{
                                widths: innerTableVars.innerWidths,
                                body: [
                                  innerColumnGen('Partnership', activity.partnership ? activity.partnership.label : ''),
                                  innerColumnGen('Mode of travel', activity.mode_of_travel),
                                ]
                              }
                            }
                          ]

                        ]
                      }
                    },
                  ]
                }
              });
              console.log(JSON.parse(JSON.stringify(mainStack)));
              return {
                stack: mainStack
              }
            }
          }
        };

        function mainHeaderGen(fieldSet) {
          return {
            style: 'mainHeader',
            margin:[-40, 20],
            table: {
              widths: [807],
              headerRows: 0,
              body: [
                [
                  {text: fieldSet.name}
                ]
              ],
            }
          }
        }

        var mainKeys = Object.keys(titleLib);
        mainKeys.forEach(function(titleKey) {
          dataToPrint.push(mainHeaderGen(titleLib[titleKey]));
          dataToPrint.push(titleLib[titleKey].generator())

        });
        return dataToPrint;
      },
      _newTravelObserver: function(isNew) {
        if(isNew) {
          this.set('data', {
            baseDetails: {},
            activities: [{}],
            itinerary: [{}],
            cost_assignments: [{}],
            deductions: [],
            expenses: [{}],
            status: 'Planned'
          })
        }
      },

      _computeStatus: function(data) {
        if(data.status) {
          return data.status.toLowerCase().replace(/ /g, '_');
        }
      },
      _computeTravelPermission: function(permissions, status, user, data) {
        var userType = undefined;
        if(data.baseDetails.id) {
          userType = 'Anyone';
          if(data.baseDetails.traveller &&  data.baseDetails.traveller.value === user.id) {
            userType = 'Traveler'
          }
          if(data.baseDetails.supervisor &&  data.baseDetails.supervisor.value === user.id) {
            userType = 'Supervisor';
          }

        }
        else if(this.newTravel) {
          userType = 'Traveler';
        }
        if(userType) {
          console.log(userType, this.status)
          this.set('travelPermissions', {});
          this.set('travelPermissions', permissions[userType][status] );
        }
      },


      _handleFormAction: function (e, details) {
        this.$['outbound-data'].doRequest(details);
      },

      _dataObserver: function(data, user) {
        var self = this;
        if (self.newTravel && data.baseDetails) {
          data.baseDetails.traveller = {
            label: user.full_name,
            value: user.id
          };
          self.notifyPath('data.baseDetails.traveller');
        }
      }
    });
  </script>
</dom-module>
